# LaPatrona.io

React PWA with Convex backend, deployed to Kubernetes via Argo CD.

## Tech Stack

| Layer | Technology |
|-------|------------|
| Frontend | React 18, TypeScript, Vite 6 |
| Routing | TanStack Router |
| State | TanStack Query |
| Backend | Convex (self-hosted at 10.0.0.215:3210) |
| PWA | vite-plugin-pwa, Workbox |
| Container | nginx:alpine |
| CI/CD | GitHub Actions → ghcr.io → Argo CD |

## Project Structure

```
lapatrona-io/
├── src/
│   ├── routes/           # TanStack Router file-based routes
│   │   ├── __root.tsx    # Root layout (header, footer, nav)
│   │   ├── index.tsx     # Home page
│   │   └── about.tsx     # About page
│   ├── components/       # Reusable components
│   ├── hooks/            # Custom hooks (useVersionCheck)
│   ├── config.ts         # Runtime config from window.__APP_CONFIG__
│   └── main.tsx          # App entry point
├── convex/
│   ├── schema.ts         # Database schema
│   ├── tasks.ts          # Backend functions
│   └── _generated/       # Auto-generated types (committed)
├── public/
│   └── config.js         # Runtime config (generated at container start)
├── Dockerfile            # Multi-stage build (node → nginx)
├── docker-entrypoint.sh  # Generates config.js from APP_* env vars
└── nginx.conf            # SPA routing config
```

## Development

```bash
# Install dependencies
npm install

# Start Vite dev server (frontend only)
npm run dev

# Start Convex dev server (backend)
npm run convex

# Build for production
npm run build
```

## Runtime Configuration

Environment variables are injected at container startup, not build time ("build once, deploy anywhere").

**How it works:**
1. `docker-entrypoint.sh` reads all `APP_*` environment variables
2. Generates `/usr/share/nginx/html/config.js` with `window.__APP_CONFIG__`
3. `src/config.ts` reads from `window.__APP_CONFIG__` with fallbacks

**Available config:**
| Variable | Config Key | Default |
|----------|------------|---------|
| `APP_CONVEX_URL` | `convexUrl` | - |
| `APP_ENVIRONMENT` | `environment` | "development" |
| `APP_VERSION` | `version` | Read from `/VERSION` file |

**Adding new config:**
1. Add env var to Kubernetes deployment: `APP_MY_VAR: "value"`
2. Add to `src/config.ts` interface and getter
3. Use via `config.myVar` in components

## Versioning

Uses **CalVer**: `YYYY.MM.DD.NN` (e.g., `2026.01.07.05`)

- Version is generated by GitHub Actions on each push to main
- Baked into Docker image as `/VERSION` file (single source of truth)
- `docker-entrypoint.sh` reads VERSION and exports as `APP_VERSION`

## CI/CD Pipeline

```
Push to main
     ↓
GitHub Actions (.github/workflows/build-push.yaml)
     ↓
Build Docker image with CalVer tag
     ↓
Push to ghcr.io/luis-echegaray/lapatrona-io
     ↓
Argo CD Image Updater detects new tag
     ↓
Updates kustomization.yaml in argocd-apps repo
     ↓
DEV: Auto-sync (immediate deployment)
PROD: Manual sync (review in Argo CD UI first)
```

## Deployment

**Environments:**
| Env | Namespace | IP | Auto-sync |
|-----|-----------|-----|-----------|
| Dev | lapatrona-dev | 10.0.0.226 | Yes |
| Prod | lapatrona-prod | 10.0.0.228 | No (manual) |

**Manifests location:** `argocd-apps/apps/{dev,prod}/lapatrona/`

**Promotion workflow:**
1. Push code → automatically deploys to dev
2. Validate in dev
3. Sync lapatrona-prod in Argo CD UI to promote

## Features

### Update Notification
When a new version is deployed, users see a popup prompting to refresh:
- `useVersionCheck` hook polls `/VERSION` every 60 seconds
- Compares against cached `config.version`
- Shows notification when versions differ

### Version Badge
Footer displays current version and environment (env badge hidden in production).

## Convex Backend

Self-hosted Convex instance at `http://10.0.0.215:3210`.

**Schema:**
```typescript
tasks: {
  text: string,
  completed: boolean,
  createdAt: number
}
```

**Important:** `convex/_generated/` is committed to the repo (required for Docker builds without Convex CLI).

## Docker Build

Multi-stage build:
1. **Builder stage**: Node 20, runs `npm ci && npm run build`
2. **Runtime stage**: nginx:alpine, serves static files

The `APP_VERSION` build arg bakes the version into the image.

## Common Tasks

### Add a new route
1. Create `src/routes/mypage.tsx`
2. Export `Route` using `createFileRoute`
3. TanStack Router auto-generates route tree

### Add a new env var
1. Add to deployment: `APP_NEW_VAR: "value"`
2. Add to `src/config.ts`:
   ```typescript
   export interface AppConfig {
     // ...
     newVar: string;
   }
   // In config object:
   newVar: getConfigValue("newVar", "VITE_NEW_VAR", "default"),
   ```

### Debug runtime config
```bash
curl http://10.0.0.226/config.js
curl http://10.0.0.226/VERSION
```
